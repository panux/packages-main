packages:
  llvm:
version: 4.0.1
builddependencies:
- xz
- gnupg
- cmake
- libffi-dev
- python
- libstdc++
- g++
sources:
- https://releases.llvm.org/{{.Version}}/hans-gpg-key.asc
oneshell: true
script:
- apk update
- gpg --import src/hans-gpg-key.asc
- wget http://llvm.org/releases/{{.Version}}/llvm-{{.Version}}.src.tar.xz.sig
- wget http://llvm.org/releases/{{.Version}}/llvm-{{.Version}}.src.tar.xz
- curl https://git.alpinelinux.org/cgit/aports/plain/main/llvm4/llvm-fix-DynamicLibrary-to-build-with-musl-libc.patch?id=HEAD > llvm-fix-DynamicLibrary-to-build-with-musl-libc.patch
- curl https://reviews.llvm.org/file/data/n35uo3zj7ecmkxghkgnd/PHID-FILE-g62ekzl6tmu4lryqmweq/D34943.id105061.diff > redef.patch
- gpg --verify llvm-{{.Version}}.src.tar.xz.sig
- xz -d llvm-{{.Version}}.src.tar.xz
- tar -xf llvm-{{.Version}}.src.tar
- mv llvm-{{.Version}}.src llvm
- (cd llvm && patch -p1 -i ../llvm-fix-DynamicLibrary-to-build-with-musl-libc.patch)
- (cd llvm/include && patch -p1 -i ../../redef.patch)
- mkdir llvm/build
- (cd llvm/build && cmake CC=clang CXX=clang++ -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_DOXYGEN=OFF -DSPHINX_WARNINGS_AS_ERRORS=OFF ..)
- $(MAKE) -C llvm/build
- $(MAKE) -C llvm/build install DESTDIR=$(shell pwd)/out/llvm
